# AeroTest AI 2.0 - 集成测试方案

**编写日期**: 2025-12-18  
**测试目标**: 验证五层漏斗完整功能  
**测试类型**: 集成测试 + 端到端测试

---

## 📋 测试概览

### 测试范围

```
┌─────────────────────────────────────────────────┐
│              五层漏斗测试范围                    │
├─────────────────────────────────────────────────┤
│ ✅ L1: 规则槽位提取                             │
│ ✅ L2: 属性匹配和评分                           │
│ ✅ L3: 空间布局推理                             │
│ 🟡 L4: AI 推理（Mock）                          │
│ ⏭️ L5: 视觉识别（跳过，需要真实截图）          │
│ ✅ L1-L2 组合                                   │
│ ✅ L1-L2-L3 组合                                │
│ 🟡 L1-L2-L4 组合（Mock）                        │
│ ⏭️ 完整 E2E（需要真实浏览器）                  │
└─────────────────────────────────────────────────┘
```

---

## 🎯 测试用例设计

### 测试用例 1: L1-L2 简单属性匹配

**场景**: 用户输入用户名  
**指令**: "在用户名输入框输入 admin"  
**预期流程**:

```
L1: 提取槽位
   ↓
   {action: INPUT, target: "用户名输入框", value: "admin"}
   ↓
L2: 属性匹配
   ↓
   找到: <input id="username" placeholder="请输入用户名">
   得分: > 0.9
   ↓
✅ 成功
```

**断言**:
```python
# L1 断言
assert slot.action_type == "INPUT"
assert "用户名" in slot.target_text
assert slot.value == "admin"

# L2 断言
assert len(l2_results) > 0
assert l2_results[0].score > 0.7
assert l2_results[0].element.backend_node_id == 2
```

**预期性能**:
- L1: < 10ms
- L2: < 50ms
- 总计: < 60ms

---

### 测试用例 2: L1-L2-L3 空间布局

**场景**: 点击输入框旁边的清除按钮  
**指令**: "点击用户名输入框右边的清除按钮"  
**预期流程**:

```
L1: 提取槽位
   ↓
   {action: CLICK, target: "用户名输入框右边的清除按钮"}
   ↓
L2: 属性匹配
   ↓
   找不到明确匹配（清除按钮无文本）
   得分: < 0.8
   ↓
L3: 空间布局推理
   ↓
   1. 识别空间关系："用户名输入框" + "右边"
   2. 定位锚点：<input id="username">
   3. 邻近搜索：右侧 200px 内
   4. 找到：<button class="clear-btn">
   ↓
✅ 成功
```

**断言**:
```python
# L1 断言
assert slot.action_type == "CLICK"
assert "用户名" in slot.target_text

# L3 断言
assert context.l3_candidates is not None
assert len(context.l3_candidates) > 0
assert context.l3_candidates[0].element.backend_node_id == 3
```

**预期性能**:
- L1: < 10ms
- L2: < 50ms
- L3: < 100ms
- 总计: < 160ms

---

### 测试用例 3: L1-L2-L4 AI 推理

**场景**: 选择最便宜的商品  
**指令**: "选择最便宜的商品"  
**预期流程**:

```
L1: 提取槽位
   ↓
   {action: CLICK, target: "最便宜的商品"}
   ↓
L2: 属性匹配
   ↓
   找到: 3 个商品卡片
   但无法判断"最便宜"
   ↓
L4: AI 推理
   ↓
   1. 提取上下文：商品 A (¥99), 商品 B (¥79), 商品 C (¥129)
   2. 调用 Qwen API
   3. AI 返回：选择商品 B（索引 1）
   ↓
✅ 成功
```

**断言**:
```python
# L1 断言
assert slot.action_type == "CLICK"

# L2 断言
assert len(l2_results) >= 3  # 找到 3 个商品

# L4 断言
assert context.l4_candidates is not None
assert context.l4_candidates[0].element.backend_node_id == 7  # 商品 B
```

**预期性能**:
- L1: < 10ms
- L2: < 50ms
- L4: < 2000ms（含 AI 调用）
- 总计: < 2060ms

**Mock 策略**:
```python
# Mock Qwen API 响应
mock_response = {
    "selected_index": 1,
    "reason": "商品 B 价格最低（¥79）"
}
mocker.patch.object(
    l4_engine.qwen_client,
    "chat_with_json",
    return_value=mock_response
)
```

---

### 测试用例 4: 完整用例流程（E2E）

**场景**: 用户登录流程  
**步骤**:
1. 打开登录页
2. 输入用户名 "admin"
3. 输入密码 "password123"
4. 点击登录按钮
5. 验证登录成功

**预期流程**:

```
Step 1: 打开登录页
   └─ 使用 CDP Session

Step 2: 输入用户名
   └─ L1-L2 (< 60ms)

Step 3: 输入密码
   └─ L1-L2 (< 60ms)

Step 4: 点击登录
   └─ L1-L2 (< 60ms)

Step 5: 验证成功
   └─ 检查 DOM 变化 / URL 变化

总计: < 10s
```

**断言**:
```python
# 每个步骤的断言
assert step1_success == True
assert step2_success == True
assert step3_success == True
assert step4_success == True
assert step5_success == True

# 最终状态断言
assert current_url.endswith("/dashboard")
或
assert "欢迎回来" in page_text
```

**状态**: ⏭️ 跳过（需要 OODA Engine 和真实浏览器）

---

### 测试用例 5: 性能基准测试

**目标**: 验证各层性能符合需求

**测试内容**:

| 层级 | 目标 | 测试方法 | 断言 |
|------|------|----------|------|
| L1 | < 50ms | 100 次循环取平均 | < 50ms |
| L2 | < 200ms | 10 次循环取平均 | < 200ms |
| L3 | < 500ms | 10 次循环取平均 | < 500ms |

**测试代码**:
```python
import time

# L1 性能测试
start = time.time()
for _ in range(100):
    await l1_engine.extract_slot("点击提交按钮")
l1_time = (time.time() - start) / 100 * 1000

assert l1_time < 50, f"L1 应 < 50ms，实际: {l1_time:.2f}ms"
```

---

## 🛠️ 测试环境准备

### 依赖安装

```bash
# 安装测试依赖
poetry install --with dev

# 或者
pip install pytest pytest-asyncio pytest-mock
```

### Mock 数据准备

```python
# 创建示例 DOM 状态
def create_sample_dom():
    """创建测试用的 DOM 状态"""
    return SerializedDOMState(
        simplified_nodes=[
            # 用户名输入框
            EnhancedDOMTreeNode(...),
            # 密码输入框
            EnhancedDOMTreeNode(...),
            # 商品卡片
            EnhancedDOMTreeNode(...),
        ],
        selector_map={},
    )
```

---

## 🚀 运行测试

### 运行所有测试

```bash
cd D:\projects\OODA

# 运行集成测试
pytest tests/integration/test_five_layer_funnel.py -v -s

# 或运行特定测试用例
pytest tests/integration/test_five_layer_funnel.py::TestFiveLayerFunnelIntegration::test_case_1_l1_l2_simple_attribute_match -v -s
```

### 查看测试报告

```bash
# 生成覆盖率报告
pytest --cov=aerotest --cov-report=html

# 打开报告
start htmlcov/index.html
```

---

## 📊 预期测试结果

### 成功场景

```
=== 测试用例 1: 简单属性匹配（L1-L2） ===
📝 指令: 在用户名输入框输入 admin

🔍 Step 1: L1 槽位提取
✅ L1 提取成功: ActionSlot(action=INPUT, target="用户名输入框", value="admin")

🔍 Step 2: L2 属性匹配
✅ L2 匹配成功: 得分=0.95, 元素ID=2

✅ 测试用例 1 通过: L1-L2 简单场景正常工作
====================================================
PASSED
```

### 失败场景

```
=== 测试用例 2: 空间布局推理（L1-L2-L3） ===
📝 指令: 点击用户名输入框右边的清除按钮

🔍 Step 1: L1 槽位提取
✅ L1 提取成功

🔍 Step 2: L2 属性匹配
⚠️ L2 失败或低分（预期行为），进入 L3

🔍 Step 3: L3 空间布局推理
❌ FAILED: L3 未找到匹配

断言错误: assert len(context.l3_candidates) > 0
====================================================
FAILED
```

---

## 📈 测试覆盖率目标

### 目标覆盖率

| 模块 | 目标覆盖率 | 当前覆盖率 |
|------|------------|------------|
| L1 引擎 | > 90% | ~90% |
| L2 引擎 | > 85% | ~85% |
| L3 引擎 | > 80% | ~70% |
| L4 引擎 | > 70% | 0% (需 Mock) |
| L5 引擎 | > 60% | 0% (需环境) |
| **总计** | **> 80%** | **~60%** |

---

## 🐛 已知限制

### 当前测试限制

1. **L4 测试需要 Mock**
   - 原因：Qwen API 需要真实调用或 Mock
   - 方案：使用 `pytest-mock` Mock API 响应

2. **L5 测试需要真实浏览器**
   - 原因：需要截图功能
   - 方案：跳过或使用 Mock 图片

3. **完整 E2E 需要 OODA Engine**
   - 原因：当前只有独立的五层引擎
   - 方案：实现 OODA Engine 后补充

4. **CDP Session 测试需要真实浏览器**
   - 原因：需要 Chrome 实例
   - 方案：使用集成测试环境或 Mock

---

## ✅ 验收标准

### MVP 验收标准

```
✅ L1 提取准确率 > 95%
✅ L2 匹配准确率 > 80%（简单场景）
✅ L3 空间推理准确率 > 85%（空间场景）
🟡 L4 AI 推理准确率 > 90%（Mock 测试通过）
⏭️ L5 视觉识别准确率 > 80%（跳过）

✅ L1 性能 < 50ms
✅ L2 性能 < 200ms
✅ L3 性能 < 500ms

✅ 集成测试通过率 > 95%
🟡 E2E 测试（待实现 OODA Engine）
```

---

## 📝 测试报告模板

### 测试执行报告

```markdown
# 测试执行报告

**执行日期**: 2025-12-18  
**执行人**: 测试工程师  
**环境**: Python 3.10, Windows 11

## 执行结果

| 测试用例 | 状态 | 耗时 | 备注 |
|----------|------|------|------|
| 用例 1: L1-L2 简单匹配 | ✅ PASSED | 45ms | - |
| 用例 2: L1-L2-L3 空间 | ✅ PASSED | 98ms | - |
| 用例 3: L1-L2-L4 AI | 🟡 SKIPPED | - | 需要 Mock |
| 用例 4: 完整 E2E | ⏭️ SKIPPED | - | 需要 OODA |
| 用例 5: 性能基准 | ✅ PASSED | - | 符合要求 |

## 总结

- **通过率**: 3/3 (100%)
- **跳过**: 2 个（预期）
- **问题**: 无
- **建议**: 实现 OODA Engine 后补充 E2E 测试

## 性能数据

- L1 平均耗时: 4.2ms ✅
- L2 平均耗时: 42.1ms ✅
- L3 平均耗时: 95.3ms ✅
```

---

## 🔧 后续改进

### 短期（1-2 周）

1. ✅ 添加更多边界案例测试
2. ✅ 实现 L4 完整 Mock 测试
3. ✅ 提高测试覆盖率到 80%+

### 中期（1-2 个月）

4. ✅ 实现 OODA Engine
5. ✅ 添加完整 E2E 测试
6. ✅ 添加真实浏览器测试
7. ✅ 添加性能压测

---

**测试方案完成日期**: 2025-12-18  
**下一步**: 运行测试并分析结果

